<!doctype html>
<html lang="zh"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="keywords" content="Using Java Reflection In a DSL-like Style - 架构教练,架构师个人成长教练,个人成长,组织成长,个人与组织成长顾问, architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学"> 
  <meta name="description" content="Using Java Reflection In a DSL-like Style - 扶墙老师说，王福强的个人博客， 一个架构士的思考与沉淀"> 
  <meta name="author" content="王福强"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
  <title>Using Java Reflection In a DSL-like Style -王福强的个人博客：一个架构士的思考与沉淀</title> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <style type="text/css">code{white-space: pre;}</style> 
  <style type="text/css">
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style> 
  <script src="https://unpkg.com/htmx.org@1.9.5"></script> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> 
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> 
  <script type="text/javascript" src="/js/watermark.js"></script> <!-- Bootstrap core CSS --> 
  <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!-- Custom fonts for this template --> 
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> <!-- Custom styles for this template --> 
  <link href="/css/freelancer.css" rel="stylesheet"> 
  <style type="text/css">
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      text-align: left;
      position: relative;
      -webkit-font-smoothing: antialiased;
    }
    

    h1{
      margin-top: 3rem;
    }
  </style> 
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "Using Java Reflection In a DSL-like Style",
      "image": [
        "https://afoo.me/images/fb_subscribe.jpg"
       ],
      "datePublished": "0000-00-00",
      "author": [{
          "@type": "Person",
          "name": "王福强",
          "url": "https://afoo.me"
        }]
    }
  </script> 
 </head> 
 <body id="page-top"> <!-- Navigation --> 
  <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav"> 
   <div class="container"> <a class="navbar-brand js-scroll-trigger" href="/"> <img src="/images/profile.jpeg" alt="" style="display: inline; border-radius: 50%; height: 50px;">王福强的个人博客 </a> <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"> Menu <i class="fas fa-bars"></i> </button> 
    <div class="collapse navbar-collapse" id="navbarResponsive"> 
     <ul class="navbar-nav ml-auto"> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/posts.html">博客文章</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/books.html">创作出版</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="https://edu.afoo.me">福强AI学堂</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/crosslinks.html">更多链接</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/whoami.html">关于我</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/feeds.xml">RSS订阅</a> </li> 
     </ul> 
    </div> 
   </div> 
  </nav> 
  <section> 
   <div class="container"> <!--        <div class="row">--> <!--          <div class="col-lg-8 mx-auto">--> 
    <p class="lead"> </p>
    <h1 class="title">Using Java Reflection In a DSL-like Style</h1> 
    <p></p> 
    <hr> 
    <p>I know someone must have heard or known about a library named FEST-Reflect, and maybe you are just using it. It’s an interesting library that let you write code of java reflection in a DSL-like style. For example:</p> 
    <div class="sourceCode" id="cb1">
     <pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> name <span class="op">=</span> <span class="fu">method</span><span class="op">(</span><span class="st">"get"</span><span class="op">).</span><span class="fu">withReturnType</span><span class="op">(</span><span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span>  </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                           <span class="op">.</span><span class="fu">withParameterTypes</span><span class="op">(</span><span class="dt">int</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                           <span class="op">.</span><span class="fu">in</span><span class="op">(</span>names<span class="op">)</span>  </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                           <span class="op">.</span><span class="fu">invoke</span><span class="op">(</span><span class="dv">8</span><span class="op">);</span>  </span></code></pre>
    </div> 
    <p>It’s just another way to express same logic, but it give you another way to write your code which make your code more readable. If you want to write your code this way, of course, you can use FEST-reflect directly, but that’s not why wrote words below, what I try to tell you is, you can implement such things yourself with little effort. I will draft a prototype to implement such a DSL-like style Java Reflection usage API, If you are interested, read on…</p> 
    <p>To enable the users to use our API in a DSL-like style like code sample above, it’s easy to figure out 2 things:</p> 
    <ol type="1"> 
     <li>We have to enable method chaining.</li> 
     <li>Static import feature after Java5 may be needed so that the code looks like a DSL syntax.</li> 
    </ol> 
    <p>So first, we have to find out which operations or methods can be used.</p> 
    <p>We focus on only java reflection usage on Instance Method, since it’s not a difficult thing to find out what we can do with Method, An abstraction can be given below:</p> 
    <div class="sourceCode" id="cb2">
     <pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> method<span class="co">("</span>name<span class="co">").</span>on<span class="co">(</span>targetobject<span class="co">).</span>withArgumentTypes<span class="co">(...).</span>invoke<span class="co">(...);</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author fujohnwang </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since  <span class="co">1.0</span>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> IMethodDSL <span class="op">{</span>  </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    IMethodDSL <span class="fu">on</span><span class="op">(</span><span class="bu">Object</span> target<span class="op">);</span>  </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    IMethodDSL <span class="fu">withArgumentTypes</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?&gt;</span><span class="kw">...</span> args<span class="op">);</span>  </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    IMethodDSL <span class="fu">makeAccessible</span><span class="op">(</span><span class="dt">boolean</span> flag<span class="op">);</span>  </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>T<span class="op">&gt;</span> T <span class="fu">invoke</span><span class="op">(</span><span class="bu">Object</span><span class="kw">...</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">InvocationTargetException</span><span class="op">;</span>  </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  </span></code></pre>
    </div> 
    <p>We express the abstraction in an Java interface, except for the last “invoke” method, other operations have a return type of the same interface, that’s, IMethodDSL itself. That’s the way we implement a method chaining behavior.</p> 
    <p>Since we have had the key abstraction, we can give it an implementation now, it looks like below:</p> 
    <div class="sourceCode" id="cb3">
     <pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Default IMethodDSL implementation<span class="co">.</span><span class="kw">&lt;br&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author fujohnwang </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since  <span class="co">1.0</span>  </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>see    ReflectDSL </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>see    IMethodDSL </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span>  </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MethodDSL <span class="kw">implements</span> IMethodDSL <span class="op">{</span>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> logger <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>MethodDSL<span class="op">.</span><span class="fu">class</span><span class="op">);</span>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> methodName<span class="op">;</span>  </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> target<span class="op">;</span>  </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Class</span><span class="op">&lt;?&gt;[]</span> argTypes<span class="op">;</span>  </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> accessible<span class="op">;</span>  </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MethodDSL</span><span class="op">(</span><span class="bu">String</span> methodName<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">methodName</span> <span class="op">=</span> methodName<span class="op">;</span>  </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> T <span class="fu">invoke</span><span class="op">(</span><span class="bu">Object</span><span class="kw">...</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">InvocationTargetException</span> <span class="op">{</span>  </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">checkInvokeDependencies</span><span class="op">();</span>  </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span>  </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Method</span> method <span class="op">=</span> <span class="fu">findQualifiedMethod</span><span class="op">(</span>target<span class="op">.</span><span class="fu">getClass</span><span class="op">());</span>  </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">accessible</span><span class="op">)</span>  </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span>  </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                method<span class="op">.</span><span class="fu">setAccessible</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>  </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">/**</span> </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>             <span class="co">*</span> usually<span class="co">,</span> the caller will be required to declare proper return type of the method invocation<span class="co">,</span> </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>             <span class="co">*</span> so cast to the type they declared is acceptable<span class="co">.  </span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>             <span class="co">*</span> the return type the caller declared should be the returnType they have assigned<span class="co">.</span> </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>             <span class="co">*/</span>  </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">@SuppressWarnings</span><span class="op">(</span><span class="st">"unchecked"</span><span class="op">)</span>  </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            T result <span class="op">=</span> <span class="op">(</span>T<span class="op">)</span>method<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>target<span class="op">,</span> PreConditions<span class="op">.</span><span class="fu">nullAsEmpty</span><span class="op">(</span>args<span class="op">,</span><span class="bu">Object</span><span class="op">.</span><span class="fu">class</span><span class="op">));</span>  </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result<span class="op">;</span>  </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">SecurityException</span> e<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">InvocationTargetException</span><span class="op">(</span>e<span class="op">);</span>  </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">NoSuchMethodException</span> e<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">InvocationTargetException</span><span class="op">(</span>e<span class="op">);</span>  </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IllegalArgumentException</span> e<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">InvocationTargetException</span><span class="op">(</span>e<span class="op">);</span>  </span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IllegalAccessException</span> e<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">InvocationTargetException</span><span class="op">(</span>e<span class="op">);</span>  </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>  </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Method</span> <span class="fu">findQualifiedMethod</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz<span class="op">)</span> <span class="kw">throws</span> <span class="bu">SecurityException</span><span class="op">,</span> <span class="bu">NoSuchMethodException</span> <span class="op">{</span>  </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">argTypes</span> <span class="op">==</span> <span class="kw">null</span><span class="op">)</span>  </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span>  </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Method</span> qualifiedMethod <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>  </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="bu">Method</span> method <span class="op">:</span> clazz<span class="op">.</span><span class="fu">getDeclaredMethods</span><span class="op">())</span>  </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span>  </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span><span class="op">(</span>method<span class="op">.</span><span class="fu">getName</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">methodName</span><span class="op">))</span>  </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span>  </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span><span class="op">(</span>qualifiedMethod <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span>  </span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                    <span class="op">{</span>  </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalStateException</span><span class="op">(</span><span class="st">"please provide arguments of method if you want to invoke on overloaded methods."</span><span class="op">);</span>  </span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>  </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                    qualifiedMethod <span class="op">=</span> method<span class="op">;</span>  </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>  </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>  </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>qualifiedMethod <span class="op">==</span> <span class="kw">null</span><span class="op">)</span>  </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span>  </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">NoSuchMethodException</span><span class="op">();</span>  </span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>  </span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> qualifiedMethod<span class="op">;</span>  </span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>  </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>  </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span>  </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> clazz<span class="op">.</span><span class="fu">getDeclaredMethod</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">methodName</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="fu">argTypes</span><span class="op">);</span>  </span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>  </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span> </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> usually<span class="co">,</span> these information like <span class="co">"</span>methodName<span class="co">",</span> <span class="co">"</span>target<span class="co">"</span> are required<span class="co">,</span> <span class="kw">&lt;br&gt;</span> </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> but in case special situations<span class="co">,</span> this method is declared protected so that in those situations<span class="co">,</span>  </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> others can override this default behavior<span class="co">. </span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span>  </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">checkInvokeDependencies</span><span class="op">()</span> <span class="op">{</span>  </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">"the data is lazily bound before the real invocation of the method, check before invocation here."</span><span class="op">);</span>  </span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        PreConditions<span class="op">.</span><span class="fu">isNotEmpty</span><span class="op">(</span>methodName<span class="op">);</span>  </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        PreConditions<span class="op">.</span><span class="fu">isNotNull</span><span class="op">(</span>target<span class="op">);</span>  </span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> IMethodDSL <span class="fu">on</span><span class="op">(</span><span class="bu">Object</span> target<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">target</span> <span class="op">=</span> target<span class="op">;</span>  </span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span>  </span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> IMethodDSL <span class="fu">withArgumentTypes</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?&gt;</span><span class="kw">...</span> args<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">argTypes</span> <span class="op">=</span> args<span class="op">;</span>  </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span>  </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> IMethodDSL <span class="fu">makeAccessible</span><span class="op">(</span><span class="dt">boolean</span> flag<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">accessible</span> <span class="op">=</span> flag<span class="op">;</span>  </span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span>  </span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  </span></code></pre>
    </div> 
    <p>The intermediate operations just accept the parameter value and “return this;” to achieve method chaining, the key point is the last operation, that’s, the “invoke” method, this is where all of the real stuff take effect. We check the preconditions before invoking Java Reflection API, and then find proper Method with attribute the API user have passed in as chaining-method’s parameter. At last, cast the invocation result to the type the users expect to get. That’s all, very simple , isn’t it?</p> 
    <p>To make API users to use this more DSL-likely, we need to offer a Factory-method for our MethodDSL, it looks like:</p> 
    <div class="sourceCode" id="cb4">
     <pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">abstract</span> <span class="kw">class</span> ReflectDSL <span class="op">{</span>  </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> IMethodDSL <span class="fu">method</span><span class="op">(</span><span class="bu">String</span> methodName<span class="op">)</span>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">MethodDSL</span><span class="op">(</span>methodName<span class="op">);</span>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span>  </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  </span></code></pre>
    </div> 
    <p>With this, we can use our DSL-like Java Reflection API this way:</p> 
    <div class="sourceCode" id="cb5">
     <pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">static</span><span class="im"> </span><span class="op">..</span><span class="im">ReflectionDSL</span><span class="op">.*;</span>  </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">method</span><span class="op">(</span><span class="st">"methodName"</span><span class="op">)</span>  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">on</span><span class="op">(</span>targetObject<span class="op">)</span>  </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withArgumentTypes</span><span class="op">(</span><span class="kw">...</span><span class="op">)</span>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">makeAccessable</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span>  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">invoke</span><span class="op">(</span><span class="kw">...</span><span class="op">);</span> </span></code></pre>
    </div> 
    <p>Of course, some parameters are optional, like the makeAccessable() if it’s a public method.</p> 
    <p>Until now, we have implement a simple DSL-like style java reflection AP for method, you can move on to provide such similar APIs for Field and Constructor and Static Method and so on.</p> 
    <p>The way we used to implement such DSL-like style API have some limitations or defects, for example, we bind intermediate method late and the final effect takes at last, that means, if users use our API in an improper way, they will not get warnings or errors until runtime. To fix this, we can use intermediate type for chaining methods, how? try it yourself and have fun ;-)</p> 
    <blockquote> 
     <p>NOTE</p> 
     <p>IMHO, this may not bring any benefits for you or your customers, it’s just another way to write your code and make it more readable, make a balance to figure out whether it’s proper to do it in your own situations.</p> 
    </blockquote> <!--          </div>--> <!--        </div>--> 
    <hr> 
    <div> <a href="/posts.html"> <b> &gt;&gt;&gt;&gt;&gt;&gt; 更多阅读 &lt;&lt;&lt;&lt;&lt;&lt; </b></a> 
    </div> 
    <div id="random_posts"> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2022-07-13-wps-dilemma.html">借着WPS的困境讲讲三种维度的架构 </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2023-06-20-ali-reorg.html">啥？阿里巴巴又做组织结构调整了？！ </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2009-10-21-thinking_in_how_to_improve_ROMA_framework.html">ROMA框架潜在改进点思考 </a> 
     </div> 
    </div> 
    <div id="comments"></div> 
    <hr> 
    <div> 
     <p> 「为AI疯狂」星球上，扶墙老师正在和朋友们讨论有趣的AI话题，你要不要⼀起来呀？^-^<br> 这里 </p>
     <ol> 
      <li>不但有及时新鲜的AI资讯和深度探讨</li> 
      <li>还分享AI工具、产品方法和商业机会</li> 
      <li>更有体系化精品付费内容等着你，<a href="https://t.zsxq.com/0dI3ZA0sL">加入星球(https://t.zsxq.com/0dI3ZA0sL)</a> 即可免费领取。(加入之后<b>一定记得看置顶消息</b>呀！)</li> 
     </ol> 
     <p></p> <a href="https://t.zsxq.com/0dI3ZA0sL"> <img src="/posts/images/2023-05-06-12-09-53.jpg" alt="知识星球二维码"> </a> 
    </div> 
    <hr> 
    <p> <span style="font-size: xx-large;">存量的时代，省钱就是赚钱。</span> <br> <span style="font-size: xx-large;">在增量的时代，省钱其实是亏钱。</span> <br> 避坑儿是省钱的一种形式，更是真正聪明人的选择！ <br> 弯路虽然也是路，但还是能少走就少走，背后都是高昂的试错成本。 <br> <b>订阅「福报」</b>，少踩坑，少走弯路，多走一步，就是不一样的胜率！ </p> <a href="https://wfq.gumroad.com/l/fb"> <img src="/images/fb_subscribe.jpg" alt="订阅「福报Premium订阅」"> </a> 
    <hr> 
    <div hx-get="https://toolfooter.afoo.me/" hx-trigger="revealed"></div> <!-- <div class="text-center">
      <a href="https://twitter.com/fujohnwang">
        <img src="/images/Twitter-logo.png" class="img-responsive" loading='lazy' style="width: fit-content;">
      </a>
    </div> --> 
   </div> 
  </section> 
  <div style="color:white; visibility: collapse; height: 0;">
   ©<a href="/whoami.html">王福强</a>个人版权所有, All Rights Reserved.
  </div> 
  <div class="copyright py-4 text-center text-white"> 
   <div class="container"> <small>Copyright © <a href="/whoami.html">王福强</a>个人版权所有 - Since 2004</small> 
    <br><small>Everything is homebrewed with <a href="https://pandoc.org/">pandoc</a> and <a href="https://daringfireball.net/projects/markdown/syntax">Markdown</a>, little <a href="https://www.scala-lang.org/">Scala</a> also included.</small> 
   </div> 
  </div> 
  <script type="text/javascript">
var gitalk = new Gitalk({
  clientID: '518a605d711883414ac0',
  clientSecret: '69fb8ccc0616c5bcbc64d24ece0d06d279da91ff',
  repo: 'afoo.me.comments',
  owner: 'fujohnwang',
  admin: ['fujohnwang'],
  id: location.pathname.substring(0, 49),      // Ensure uniqueness and length less than 50
  distractionFreeMode: false  // Facebook-like distraction free mode
})

gitalk.render('comments')
    </script> 
  <script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script> 
  <script>
  kofiWidgetOverlay.draw('fff000', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': 'red',
    'floating-chat.donateButton.text-color': 'white'
  });
</script>  <!-- <script>watermark.init({ watermark_txt: "©王福强个人版权所有, All Rights Reserved." , watermark_width:200})</script> --> 
 </body>
</html>