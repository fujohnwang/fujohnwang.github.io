<!doctype html>
<html lang="zh"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="keywords" content="N Things You should know about HandlerSocket - 架构教练,架构师个人成长教练,个人成长,组织成长,个人与组织成长顾问, architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学"> 
  <meta name="description" content="N Things You should know about HandlerSocket - 扶墙老师说，王福强的个人博客， 一个架构士的思考与沉淀"> 
  <meta name="author" content="王福强"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
  <title>N Things You should know about HandlerSocket -王福强的个人博客：一个架构士的思考与沉淀</title> 
  <meta name="date" content="2010-12-04"> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <style type="text/css">code{white-space: pre;}</style> 
  <script src="https://unpkg.com/htmx.org@1.9.5"></script> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> 
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> 
  <script type="text/javascript" src="/js/watermark.js"></script> <!-- Bootstrap core CSS --> 
  <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!-- Custom fonts for this template --> 
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> <!-- Custom styles for this template --> 
  <link href="/css/freelancer.css" rel="stylesheet"> 
  <style type="text/css">
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      text-align: left;
      position: relative;
      -webkit-font-smoothing: antialiased;
    }
    

    h1{
      margin-top: 3rem;
    }
  </style> 
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "N Things You should know about HandlerSocket",
      "image": [
        "https://afoo.me/images/fb_subscribe.jpg"
       ],
      "datePublished": "2010-12-04",
      "author": [{
          "@type": "Person",
          "name": "王福强",
          "url": "https://afoo.me"
        }]
    }
  </script> 
 </head> 
 <body id="page-top"> <!-- Navigation --> 
  <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav"> 
   <div class="container"> <a class="navbar-brand js-scroll-trigger" href="/"> <img src="/images/profile.jpeg" alt="" style="display: inline; border-radius: 50%; height: 50px;">王福强的个人博客 </a> <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"> Menu <i class="fas fa-bars"></i> </button> 
    <div class="collapse navbar-collapse" id="navbarResponsive"> 
     <ul class="navbar-nav ml-auto"> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/posts.html">博客文章</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/books.html">创作出版</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="https://edu.afoo.me">福强AI学堂</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/crosslinks.html">更多链接</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/whoami.html">关于我</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/feeds.xml">RSS订阅</a> </li> 
     </ul> 
    </div> 
   </div> 
  </nav> 
  <section> 
   <div class="container"> <!--        <div class="row">--> <!--          <div class="col-lg-8 mx-auto">--> 
    <p class="lead"> </p>
    <h1 class="title">N Things You should know about HandlerSocket</h1> <small> <h3 class="author">fujohnwang</h3> 
     <div style="text-align: left;">
      2010-12-04
     </div> </small> 
    <p></p> 
    <hr> 
    <p><strong>author: fujohnwang</strong></p> 
    <p>关于Mysql HandlerSocket Plugin你不得不知的几件事儿</p> 
    <h1 id="what-whats-handlersocket啥啥是handlersocket">What? What’s HandlerSocket?(啥?啥是HandlerSocket？)</h1> 
    <p>As you may know, after Mysql5.1, plugin mechanism is introduced into the mysql server.With Plugins, we can extend or customize the functionalities or behaviors of Mysql server. While HandlerSocket is one custom plugin for Mysql, it enables you to access the underlying storage engines of Mysql server(currently, only InnoDB is supported), without any overhead on Sql parsing things, execution planning things, etc. As the author of HandlerSocket states, with HandlerSocket, you can achieve 750000 qps, sounds fantasitic ha? To find more details on HandlerSocket, refer to this original blog about HS. Of course, you can also refer to the official site of HS on the github where you can find almost anything and get you updated with the current development process of HS.</p> 
    <p>Oh, By the way, after you want to get started with HS, and you would like to read something useful on HS in Chinese, read this , hehe, one of my old fellow wrote it.</p> 
    <h1 id="things-you-should-know">Things You should know</h1> 
    <p>OK, now, let’s get to the topic today.</p> 
    <h2 id="binlog-is-still-available-with-handlersocket">Binlog is still available with Handlersocket</h2> 
    <p>I am sorry I said binlog is not availabe when we use HandlerSocket to do data access, that’s not true. In fact, HandlerSocket implements as a Handler in mysql, and that means a callback for binlog writing needs to be implemented, so HandlerSocket will still write binlogs in the process of data access. One word, HandlerSocket will write binlog in row-based format. ## What if I only want to update specific columns of a table instead of all? When only want to update several columns, open an index with these several columns only. This is a trick, but it’s necessary for you to know it. ## pst_id will be confined in each connection, it’s mapped to prep_stat in HS codebase; So as long as you keep the pst_id identical in one connection, the index will not be crashed. Most of the time, The client should take care of the pst_id/indexId generation and management ## QueryCache invalidation issue Currently, HandlerSocket will not invalidate the query cache when updating the database, but the auther told me in the github forum that he would like to add this feature in the near futuer, maybe it will come soon;</p> 
    <p>(<strong>Update: the new version of HS has fixed this issure</strong>) ## encoded string issue When encoding the string as per the HS protocol, you have to convert a string to an array of bytes, but the protocol doesn’t mention the conversion charset, as I have asked such a question in the forum of github, the author answered we should use the encoding of the target table.</p> 
    <p>As to the string encoding, another point I should mention, as the protocol states, the client should encoding column values before sending them to HS server, but since special bytes are kept(e.g.&nbsp;0x00 as null, 0x09 as delimeter, etc.), so the protocol states that if the byte value is between 0x00 and 0x0f, special treat should be taken, that’s, encoding these special bytes by prefixing 0x01 after bitwise 0x40. But as I know, most of the Java clients didn’t pay attention to the encoding issue(Most of the time, I live in Java world, Although recently I starts to join Scala’s one), so take care on this point when you try to pick up an Opensource Java client for HandlerSocket.</p> 
    <h2 id="play-around-with-hs-via-telnet">Play around with HS via telnet</h2> 
    <pre><code>HandlerSocket protocol is a small-sized text based protocol. Like memcached text protocol, you can use telnet to get rows through HandlerSocket.</code></pre> 
    <p>So let’s have some fun.</p> Firstly, let’s create a table to play with: 
    <pre>create table dw(
 id int(10) unsigned auto_increment not null, 
 value varchar(25), primary key(id)) engine=InnoDB;
 </pre> Then, here is what we may do next: 
    <pre>Example 1. 
fujohnwangs-MacBook-Pro:~ fujohnwang$ telnet 10.16.201.39 9999
Trying 10.16.201.39...
Connected to 10.16.201.39.
Escape character is '^]'.
P 0 test dw PRIMARY value   
0 1
0 + 2 1 darren
0 1
0 = 1 0 1 0 D
0 1 1
</pre> 
    <p>Just for hint, the delimeter between value columns above is tab(0x09), not space, just as the protocol states. But in your first time, you may ignore this and cause unsuccessful interaction with HS.</p> 
    <h2 id="the-insert-columns-have-nothing-to-do-with-the-openindex-columns">The Insert columns have nothing to do with the OpenIndex columns;</h2> 
    <p>Let’s say, we have a table which has 2 columns (id int unsigned PRIMARY KEY auth_increment, value VARCHAR(25)), since we define id as auto_increment, when insert records into this table, we may only care about the value column, so we may do:</p> 
    <pre>Example 2. 
P 0 test my_table PRIMARY value
// 0 1
0 + 1 stringvalue
// 1 1
</pre> 
    <p>what? the error code is 1, not 0, it means there is something wrong. yes, Not like Update operations, the insert operation will ALWAYS insert columns from the 1st column to the last column of the table, even we only Open index with value column. In the above sample, the operation in fact try to insert stringvalue as int value which indeed will cause error.</p> 
    <blockquote>
      In fact, sometimes stringvalue will be converted to 0 instead of raising error. But the gotcha with insert is the key point here. 
    </blockquote> 
    <h2 id="auto_increment-indeed-is-the-problem-here-with-hs.">auto_increment indeed is the problem here with HS.</h2> 
    <p>why? see item above. ^_^ Of course, most of the times, it’s not a big deal as per HS’s typical usage scenarios. In distributed environments, auth_increment is not prefered.</p> 
    <p>(<strong>Update: auto_increment works now</strong>)</p> 
    <h2 id="handlersocket-doesnt-support-transaction">HandlerSocket doesn’t support transaction</h2> 
    <p>But the data changes are durable. Use HandlerSocket properly and visely in suitable scenarios.</p> 
    <h2 id="why-handlersocket-is-fast">Why HandlerSocket is fast?</h2> 
    <p>The original blog has explanation about this, here is just a conclusion:</p> 
    <ol type="1"> 
     <li>much lower CPU usage (analysis with oprofile)</li> 
     <li>execute multiple requests in bulk on server side which cause low CPU/disk usage</li> 
     <li>custom effecient text-based communication protocol, at least more effecient than mysql’s one</li> 
    </ol> 
    <h1 id="last-words-on-this">Last Words On This</h1> 
    <p>I don’t think I can list everything here on HandlerSocket, since HS will evolve continuously, So stay tuned on HS and on this topic which I may update in the future.</p> <!--          </div>--> <!--        </div>--> 
    <hr> 
    <div> <a href="/posts.html"> <b> &gt;&gt;&gt;&gt;&gt;&gt; 更多阅读 &lt;&lt;&lt;&lt;&lt;&lt; </b></a> 
    </div> 
    <div id="random_posts"> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2019-07-17-cto-and-ceo-delimma.html">为啥CTO的委屈CEO不懂 </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2010-05-04-photography.html">学习摄影总结</a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2022-10-31-how-to-delete-weibo.html">如何删除微博所有内容？ </a> 
     </div> 
    </div> 
    <div id="comments"></div> 
    <hr> 
    <div> 
     <p> 「为AI疯狂」星球上，扶墙老师正在和朋友们讨论有趣的AI话题，你要不要⼀起来呀？^-^<br> 这里 </p>
     <ol> 
      <li>不但有及时新鲜的AI资讯和深度探讨</li> 
      <li>还分享AI工具、产品方法和商业机会</li> 
      <li>更有体系化精品付费内容等着你，<a href="https://t.zsxq.com/0dI3ZA0sL">加入星球(https://t.zsxq.com/0dI3ZA0sL)</a> 即可免费领取。(加入之后<b>一定记得看置顶消息</b>呀！)</li> 
     </ol> 
     <p></p> <a href="https://t.zsxq.com/0dI3ZA0sL"> <img src="/posts/images/2023-05-06-12-09-53.jpg" alt="知识星球二维码"> </a> 
    </div> 
    <hr> 
    <p> <span style="font-size: xx-large;">存量的时代，省钱就是赚钱。</span> <br> <span style="font-size: xx-large;">在增量的时代，省钱其实是亏钱。</span> <br> 避坑儿是省钱的一种形式，更是真正聪明人的选择！ <br> 弯路虽然也是路，但还是能少走就少走，背后都是高昂的试错成本。 <br> <b>订阅「福报」</b>，少踩坑，少走弯路，多走一步，就是不一样的胜率！ </p> <a href="https://wfq.gumroad.com/l/fb"> <img src="/images/fb_subscribe.jpg" alt="订阅「福报Premium订阅」"> </a> 
    <hr> 
    <div hx-get="https://toolfooter.afoo.me/" hx-trigger="revealed"></div> <!-- <div class="text-center">
      <a href="https://twitter.com/fujohnwang">
        <img src="/images/Twitter-logo.png" class="img-responsive" loading='lazy' style="width: fit-content;">
      </a>
    </div> --> 
   </div> 
  </section> 
  <div style="color:white; visibility: collapse; height: 0;">
   ©<a href="/whoami.html">王福强</a>个人版权所有, All Rights Reserved.
  </div> 
  <div class="copyright py-4 text-center text-white"> 
   <div class="container"> <small>Copyright © <a href="/whoami.html">王福强</a>个人版权所有 - Since 2004</small> 
    <br><small>Everything is homebrewed with <a href="https://pandoc.org/">pandoc</a> and <a href="https://daringfireball.net/projects/markdown/syntax">Markdown</a>, little <a href="https://www.scala-lang.org/">Scala</a> also included.</small> 
   </div> 
  </div> 
  <script type="text/javascript">
var gitalk = new Gitalk({
  clientID: '518a605d711883414ac0',
  clientSecret: '69fb8ccc0616c5bcbc64d24ece0d06d279da91ff',
  repo: 'afoo.me.comments',
  owner: 'fujohnwang',
  admin: ['fujohnwang'],
  id: location.pathname.substring(0, 49),      // Ensure uniqueness and length less than 50
  distractionFreeMode: false  // Facebook-like distraction free mode
})

gitalk.render('comments')
    </script> 
  <script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script> 
  <script>
  kofiWidgetOverlay.draw('fff000', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': 'red',
    'floating-chat.donateButton.text-color': 'white'
  });
</script>  <!-- <script>watermark.init({ watermark_txt: "©王福强个人版权所有, All Rights Reserved." , watermark_width:200})</script> --> 
 </body>
</html>