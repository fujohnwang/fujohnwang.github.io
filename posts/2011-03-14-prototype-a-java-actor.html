<!doctype html>
<html lang="zh" class="motion-safe:scroll-smooth 2xl:text-[20px]"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="keywords" content="Prototyping An Actor In Java - 架构师， 架构士，架构教练, 教练, 个人成长, 组织成长, 独立顾问, architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学"> 
  <meta name="description" content="Prototyping An Actor In Java - 福强说，扶墙老师说，王福强的个人博客， 一个架构士的思考与沉淀"> 
  <meta name="author" content="王福强"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <meta name="robots" content="index,follow"> 
  <title>Prototyping An Actor In Java -王福强的个人博客：一个架构士的思考与沉淀</title> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <link rel="canonical" href="https://afoo.me/posts/2011-03-14-prototype-a-java-actor.html"> 
  <link rel="icon" type="image/svg+xml" href="https://afoo.me/favicon.svg"> 
  <link rel="mask-icon" href="https://afoo.me/favicon.svg" color="#3383F8"> 
  <script src="https://unpkg.com/htmx.org@1.9.5"></script> 
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"> 
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> 
  <script src="https://unpkg.com/@popperjs/core@2"></script> 
  <script src="https://unpkg.com/tippy.js@6"></script> 
  <link rel="stylesheet" href="/css/af.css"> 
  <link rel="stylesheet" href="/css/components.css"> 
  <link ref="stylesheet" href="/css/pygments.css"> 
  <style type="text/css">
        pre > code{
          white-space: pre-wrap;
          font-family: monospace;
          font-size: 14px;
          /* border-left: blueviolet;
          border-left-width: thick;
          border-left-style: double;
          padding-left: 1rem !important; */
        }
        
        .x-indicator{
            display:none;
        }
        .htmx-request .x-indicator{
            display:inline;
        }
        .htmx-request.x-indicator{
            display:inline;
        }
    </style> 
  <style type="text/css">
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #7d9029; } /* Attribute */
      code span.bn { color: #40a070; } /* BaseN */
      code span.bu { } /* BuiltIn */
      code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4070a0; } /* Char */
      code span.cn { color: #880000; } /* Constant */
      code span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code span.dt { color: #902000; } /* DataType */
      code span.dv { color: #40a070; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #40a070; } /* Float */
      code span.fu { color: #06287e; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code span.op { color: #666666; } /* Operator */
      code span.ot { color: #007020; } /* Other */
      code span.pp { color: #bc7a00; } /* Preprocessor */
      code span.sc { color: #4070a0; } /* SpecialChar */
      code span.ss { color: #bb6688; } /* SpecialString */
      code span.st { color: #4070a0; } /* String */
      code span.va { color: #19177c; } /* Variable */
      code span.vs { color: #4070a0; } /* VerbatimString */
      code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style> 
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "Prototyping An Actor In Java",
      "image": [
        "https://afoo.me/images/fb_subscribe.jpg"
       ],
      "datePublished": "0000-00-00",
      "author": [{
          "@type": "Person",
          "name": "王福强",
          "url": "https://afoo.me"
        }]
    }
  </script> 
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3687639021943715" crossorigin="anonymous"></script> 
 </head> 
 <body class="antialiased text-gray-900 dark:text-slate-300 tracking-tight bg-white dark:bg-slate-900 vsc-initialized"> 
  <header class="sticky top-0 z-40 flex-none mx-auto w-full bg-white md:bg-white/90 dark:bg-slate-900 dark:md:bg-slate-900/90 md:backdrop-blur-sm border-b dark:border-b-0" id="header"> 
   <div class="py-3 px-3 mx-auto w-full md:flex md:justify-between max-w-6xl md:px-4"> 
    <div class="flex justify-between"> <a class="flex items-center" href="https://afoo.me"> <span class="self-center ml-2 text-2xl font-extrabold text-gray-900 whitespace-nowrap dark:text-white"> <h1>王福强的博客</h1> </span> </a> 
     <div class="flex items-center md:hidden"> <button type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="Toggle between Dark and Light mode" data-toggle-color-scheme=""> 
       <svg viewbox="0 0 24 24" class="w-6 h-6" astro-icon="tabler:sun"> <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"> 
         <circle cx="12" cy="12" r="4"></circle> 
         <path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"> 
         </path> 
        </g> 
       </svg> </button> <button type="button" class="ml-1.5 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center transition" aria-label="Toggle Menu" data-toggle-menu=""> 
       <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" class="w-6 h-6" astro-icon="tabler:menu"> <g class="icon-tabler" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
         <path d="M4 8h16"></path> 
         <path d="M4 16h16"></path> 
        </g> 
       </svg> </button> 
     </div> 
    </div> 
    <nav class="items-center w-full md:w-auto hidden md:flex text-gray-600 dark:text-slate-200 h-screen md:h-auto" aria-label="Main navigation"> 
     <ul class="flex flex-col pt-8 md:pt-0 md:flex-row md:self-center w-full md:w-auto text-xl md:text-base"> 
      <li><a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://afoo.me/kb.html">福强私学</a></li> 
      <li> <a id="aiedu" class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="http://ai.afoo.me"> 福强AI学堂</a> </li> 
      <li> <a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="http://jiagoubaike.com">架构百科</a> </li> 
      <li> <a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://afoo.me/posts.html">博客文章 </a> </li> 
      <li> <a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://afoo.me/books.html">创作出版</a> </li> 
      <li> <a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://store.afoo.me">产品与服务</a> </li> 
      <li><a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://auth.afoo.me/user.html">登录信息</a></li> 
      <li> <a class="font-medium hover:text-gray-900 dark:hover:text-white px-4 py-3 flex items-center transition duration-150 ease-in-out" href="https://afoo.me/crosslinks.html">更多链接</a> </li> 
     </ul> 
     <div class="md:self-center flex items-center mb-4 md:mb-0 ml-2"> 
      <div class="hidden items-center md:flex"> <button type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="Toggle between Dark and Light mode" data-toggle-color-scheme=""> 
        <svg viewbox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:sun"> <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"> 
          <circle cx="12" cy="12" r="4"></circle> 
          <path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"> 
          </path> 
         </g> 
        </svg> </button> <a class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="RSS Feed" href="http://afoo.me/feeds.xml"> 
        <svg viewbox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:rss"> <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"> 
          <circle cx="5" cy="19" r="1"></circle> 
          <path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"></path> 
         </g> 
        </svg> </a> 
      </div> 
     </div> 
    </nav> 
   </div> 
  </header> 
  <main> 
   <div id="leftSlot" class="visible md:invisible fixed top-0 left-0" style="width: 16rem;height: 80%;margin-top: 4rem;"> <!-- left --> 
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3687639021943715" data-ad-slot="3581141418" data-ad-format="auto" data-full-width-responsive="true"></ins> 
    <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script> 
   </div> 
   <div id="rightSlot" class="visible md:invisible fixed top-0 right-0" style="width: 16rem;height: 80%;margin-top: 4rem;"> <!-- right --> 
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3687639021943715" data-ad-slot="7030836806" data-ad-format="auto" data-full-width-responsive="true"></ins> 
    <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
      </script> 
   </div> 
   <section class="text-gray-600 body-font relative"> 
    <div class="container px-5 py-24 mx-auto mb-12 prose prose-lg dark:prose-invert"> 
     <p class="lead"> </p>
     <h1 class="title">Prototyping An Actor In Java</h1> 
     <p></p> <!-- random --> 
     <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3687639021943715" data-ad-slot="2722720851" data-ad-format="auto" data-full-width-responsive="true"></ins> 
     <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script> 
     <hr> 
     <p>I have always try to implement an actor like the ones of Erlang or Scala in java, and had tried several times with different strategies. The former attempts seems naive, and I will not demonstrate it here, but the ideas from those naive prototypes still hold. Note</p> 
     <pre>    * I hope you know something about the actor model before continuing to read this.
    * We mainly focus on "fire-and-get" pattern, the "fire-and-forget" pattern is much easier to implement.
    * To simply the prototyping process, I will left any generic type design behind, hope u can polish it so that it can be your own tools.
</pre> 
     <p>Before start, we need to make something clear. In Java, the concurrency is modeled in Task-Based Concurrency, We run different logic which is modeled as tasks to run in parallel. But The actor is different, it belongs to the category of Data-Based Concurrency, to bridge the differences between this two concurrency models, I will declare an interface to confine the process logic into it:</p> 
     <div class="sourceCode" id="cb1">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> ActorClosure<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>     <span class="dt">void</span> <span class="fu">sinkEvent</span><span class="op">(</span>T event<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>ActorClosure will accept different events each time but run them one by one with same process logic. That’s why a sinkeEvent() method is declared.</p> 
     <p>Besides, we also give out an stub for our demonstration:</p> 
     <div class="sourceCode" id="cb2">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ActorClosureStub <span class="kw">implements</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> event<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>         <span class="co">// log the exception</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"received event:"</span> <span class="op">+</span> event<span class="op">);</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">sinkEvent</span><span class="op">(</span><span class="bu">String</span> event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">event</span> <span class="op">=</span> event<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>OK, background is done, let’s start with our java actor prototyping play…</p> 
     <h1 id="actor-with-same-instance-reference-of-actionfailed">Actor with Same Instance Reference of Action(Failed)</h1> 
     <p>Since each event that send to the actor should be processed by one processing logic, At first, we will just let our actor to use only one ActorClosure to process all of the events that’s sent to it. So below is the code :</p> 
     <div class="sourceCode" id="cb3">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> FailedActorWithSameReference <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">ExecutorService</span>      scheduler <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newFixedThreadPool</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> action    <span class="op">=</span> <span class="kw">new</span> <span class="fu">ActorClosureStub</span><span class="op">();</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Future</span><span class="op">&lt;?&gt;</span> <span class="fu">bang</span><span class="op">(</span><span class="bu">String</span> event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">InterruptedException</span> <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        action<span class="op">.</span><span class="fu">sinkEvent</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scheduler<span class="op">.</span><span class="fu">submit</span><span class="op">(</span>action<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">terminate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        FailedActorWithSameReference actor <span class="op">=</span> <span class="kw">new</span> <span class="fu">FailedActorWithSameReference</span><span class="op">();</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f1 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"a"</span><span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f2 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"b"</span><span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">terminate</span><span class="op">();</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>In fact, no need to run this piece of code, we can see that it won’t work properly, why? Because we didn’t handle the concurrency operation on the ActorClosure properly, the latter bang(!) will replace or corrupt the state in the ActorClosure, If you run the above piece of code, it will print “b” twice, but we do expect “a” and “b” in sequence. But the problem really is the bad concurrency control on ActorClosure? No, If we add concurrency control on ActorClosure, then we go wrong way in the process of modeling an actor.</p> 
     <p>So, no concurrency control on ActorClosure, how to avoid the state corruption?</p> 
     <h1 id="actor-with-prototype-scope-actionworkable">Actor With Prototype Scope Action(Workable)</h1> 
     <p>We of course can allocate a new ActorClosure instance for each event, in this way, the state of ActorClosures and their events will be confined into their own boundary without leak and interference.</p> 
     <p>With this in mind, we got code piece below:</p> 
     <div class="sourceCode" id="cb4">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> This actor implementation just simply works<span class="co">,</span> but it can<span class="co">'</span>t fully simulate the</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> exact behavior of an actor<span class="co">,</span> e<span class="co">.</span>g<span class="co">.</span> since we will create new action closure for</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> each event<span class="co">,</span> the states of the action closure can<span class="co">'</span>t be kept in the time<span class="co">-</span>line</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> of the actor<span class="co">,</span> maybe we should introduce some copy mechanism to complement</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> this<span class="co">.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>author fujohnwang</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">1.0</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ActorWithPrototypeScopeActionClosure <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">ExecutorService</span>                       scheduler  <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newFixedThreadPool</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> actionType <span class="op">=</span> ActorClosureStub<span class="op">.</span><span class="fu">class</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Future</span><span class="op">&lt;?&gt;</span> <span class="fu">bang</span><span class="op">(</span><span class="bu">String</span> e<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> action <span class="op">=</span> actionType<span class="op">.</span><span class="fu">newInstance</span><span class="op">();</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        action<span class="op">.</span><span class="fu">sinkEvent</span><span class="op">(</span>e<span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scheduler<span class="op">.</span><span class="fu">submit</span><span class="op">(</span>action<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setActionType</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> actionType<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">actionType</span> <span class="op">=</span> actionType<span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> <span class="fu">getActionType</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> actionType<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">terminate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        ActorWithPrototypeScopeActionClosure actor <span class="op">=</span> <span class="kw">new</span> <span class="fu">ActorWithPrototypeScopeActionClosure</span><span class="op">();</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f1 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"a"</span><span class="op">);</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f2 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"b"</span><span class="op">);</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f3 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"c"</span><span class="op">);</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        f3<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">terminate</span><span class="op">();</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>If we run the above piece of code, the result will be as we expected. Seems it work, but wait, it’s not perfect. Why? (Why again ha?) Since we wrap each event(the data) into a ActorClosureStub instance(the task), we lost the smooth timeline state of the processsing. Simply put, the ActorClosureStub runs first has no correlation with other ActorClosureStubs. But in actor’s semantics, they should be one. So although this prototyping seems work, but it still have improvement space.</p> 
     <h1 id="actor-with-state-copy-between-prototype-scope-actions">Actor With State Copy Between Prototype Scope Actions</h1> 
     <p>So I hope to copy the state between each ActorClosure after they run, in this way, the 1st ActorClosure will pass its state to the 2nd ActorClosure before the 2nd ActorClosure will run, and the 2nd ActorClosure will pass its state to the 3rd ActorClosure before the 3rd ActorClosure will run, and so on.</p> 
     <p>To make this happen, we can recall the hooks the ThreadPoolExecutor has, e.g.&nbsp;afterExecute(), beforeExecute(), furthermore, we can even directly override the execute() of it. Anyway, we can write such-alike code:</p> 
     <div class="sourceCode" id="cb5">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Although we seek to extend <span class="co">{@</span>link ActorWithPrototypeScopeActionClosure<span class="co">}</span> to</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> enable state copy between the action closures<span class="co">,</span> BUT it seems that the Executor</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> implementation doesn<span class="co">'</span>t allow us to go this way<span class="co">.</span><span class="kw">&lt;br&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> This Actor DOESN<span class="co">'</span>T Work<span class="co">!!!!</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>author fujohnwang</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">1.0</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ActorWithStateCopy <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span>                           lastClosure<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ActionClosureStateCopier<span class="op">&lt;</span>ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> stateCopier <span class="op">=</span> <span class="kw">new</span> ActionClosureStateCopier<span class="op">&lt;</span>ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;()</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="kw">public</span> <span class="dt">void</span> <span class="fu">copy</span><span class="op">(</span>ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> from<span class="op">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                                                                                            ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="bu">System</span><span class="op">.</span><span class="fu">out</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                                                                                       <span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"do copy if necessary"</span><span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                                                                       <span class="op">};</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">ExecutorService</span>                                scheduler   <span class="op">=</span> <span class="kw">new</span> <span class="bu">ThreadPoolExecutor</span><span class="op">(</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="dv">1</span><span class="op">,</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="dv">1</span><span class="op">,</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="dv">60</span><span class="op">,</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">,</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="kw">new</span> <span class="bu">ArrayBlockingQueue</span><span class="op">&lt;</span><span class="bu">Runnable</span><span class="op">&gt;(</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                                                                                       <span class="dv">10</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           @Override</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           protected void afterExecute(Runnable arg0,</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                                                       Throwable arg1) {</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                               super.afterExecute(</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                                       arg0, arg1);</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           }</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           @Override</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           protected void beforeExecute(Thread arg0,</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                                                        Runnable arg1) {</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                               super.beforeExecute(</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                                       arg0, arg1);</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="co">//                                                                           }</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">@SuppressWarnings</span><span class="op">(</span><span class="st">"unchecked"</span><span class="op">)</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">@Override</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span><span class="op">(</span><span class="bu">Runnable</span> command<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                                                                               ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> r <span class="op">=</span> <span class="op">(</span>ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;)</span> command<span class="op">;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="cf">if</span> <span class="op">(</span>lastClosure <span class="op">!=</span> <span class="kw">null</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                                                                                       <span class="op">&amp;&amp;</span> stateCopier <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>                                                                                   <span class="bu">System</span><span class="op">.</span><span class="fu">out</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>                                                                                           <span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"copy state before executing"</span><span class="op">);</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>                                                                                   stateCopier</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>                                                                                           <span class="op">.</span><span class="fu">copy</span><span class="op">(</span>lastClosure<span class="op">,</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>                                                                                                   r<span class="op">);</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="op">}</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="kw">super</span><span class="op">.</span><span class="fu">execute</span><span class="op">(</span>r<span class="op">);</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>                                                                               lastClosure <span class="op">=</span> r<span class="op">;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="op">}</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>                                                                       <span class="op">};</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span>          actionType  <span class="op">=</span> ActorClosureStub<span class="op">.</span><span class="fu">class</span><span class="op">;</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Future</span><span class="op">&lt;?&gt;</span> <span class="fu">bang</span><span class="op">(</span><span class="bu">String</span> e<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> action <span class="op">=</span> actionType<span class="op">.</span><span class="fu">newInstance</span><span class="op">();</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        action<span class="op">.</span><span class="fu">sinkEvent</span><span class="op">(</span>e<span class="op">);</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scheduler<span class="op">.</span><span class="fu">submit</span><span class="op">(</span>action<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setActionType</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> actionType<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">actionType</span> <span class="op">=</span> actionType<span class="op">;</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Class</span><span class="op">&lt;?</span> <span class="kw">extends</span> ActorClosure<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> <span class="fu">getActionType</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> actionType<span class="op">;</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">terminate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param args</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        ActorWithStateCopy actor <span class="op">=</span> <span class="kw">new</span> <span class="fu">ActorWithStateCopy</span><span class="op">();</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f1 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"a"</span><span class="op">);</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f2 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"b"</span><span class="op">);</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f3 <span class="op">=</span> actor<span class="op">.</span><span class="fu">bang</span><span class="op">(</span><span class="st">"c"</span><span class="op">);</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        f3<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">terminate</span><span class="op">();</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>Let’s run the code. Oops, something goes wrong:</p> 
     <div class="sourceCode" id="cb6">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Exception</span> in thread <span class="st">"main"</span> java<span class="op">.</span><span class="fu">lang</span><span class="op">.</span><span class="fu">ClassCastException</span><span class="op">:</span> java<span class="op">.</span><span class="fu">util</span><span class="op">.</span><span class="fu">concurrent</span><span class="op">.</span><span class="fu">FutureTask</span> cannot be cast to cn<span class="op">.</span><span class="fu">spring21</span><span class="op">.</span><span class="fu">sandbox</span><span class="op">.</span><span class="fu">actor</span><span class="op">.</span><span class="fu">ActorClosure</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a> at cn<span class="op">.</span><span class="fu">spring21</span><span class="op">.</span><span class="fu">sandbox</span><span class="op">.</span><span class="fu">actor</span><span class="op">.</span><span class="fu">ActorWithStateCopy</span>$<span class="fl">2.</span><span class="fu">execute</span><span class="op">(</span>ActorWithStateCopy<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">55</span><span class="op">)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a> at java<span class="op">.</span><span class="fu">util</span><span class="op">.</span><span class="fu">concurrent</span><span class="op">.</span><span class="fu">AbstractExecutorService</span><span class="op">.</span><span class="fu">submit</span><span class="op">(</span><span class="bu">AbstractExecutorService</span><span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">85</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a> at cn<span class="op">.</span><span class="fu">spring21</span><span class="op">.</span><span class="fu">sandbox</span><span class="op">.</span><span class="fu">actor</span><span class="op">.</span><span class="fu">ActorWithStateCopy</span><span class="op">.</span><span class="fu">bang</span><span class="op">(</span>ActorWithStateCopy<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">76</span><span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a> at cn<span class="op">.</span><span class="fu">spring21</span><span class="op">.</span><span class="fu">sandbox</span><span class="op">.</span><span class="fu">actor</span><span class="op">.</span><span class="fu">ActorWithStateCopy</span><span class="op">.</span><span class="fu">main</span><span class="op">(</span>ActorWithStateCopy<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">96</span><span class="op">)</span> </span></code></pre>
     </div> 
     <p>See the problem? Wow, ThreadPoolExecutor really do some dirty things there, and I tries to bypass it but finally, I found I couldn’t :-(</p> 
     <h1 id="raw-thread-based-actor-prototyping-workable">Raw Thread Based Actor Prototyping (Workable)</h1> 
     <p>I fall back to a raw thread solution for the actor. The final code is listed here:</p> 
     <div class="sourceCode" id="cb7">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ImprovedThreadBasedActor<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Thread</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span>            logger  <span class="op">=</span> LoggerFactory</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                                           <span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>ImprovedThreadBasedActor<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">BlockingQueue</span><span class="op">&lt;</span>EventWrapper<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> mailbox<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">volatile</span> <span class="dt">boolean</span>               running <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ActorClosure<span class="op">&lt;</span>T<span class="op">&gt;</span>                action<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ImprovedThreadBasedActor</span><span class="op">(</span>ActorClosure<span class="op">&lt;</span>T<span class="op">&gt;</span> action<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">(</span>action<span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ImprovedThreadBasedActor</span><span class="op">(</span>ActorClosure<span class="op">&lt;</span>T<span class="op">&gt;</span> action<span class="op">,</span> <span class="dt">int</span> mailboxSize<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        Validate<span class="op">.</span><span class="fu">notNull</span><span class="op">(</span>action<span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        mailbox <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayBlockingQueue</span><span class="op">&lt;</span>EventWrapper<span class="op">&lt;</span>T<span class="op">&gt;&gt;(</span>mailboxSize <span class="op">&lt;=</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">100</span> <span class="op">:</span> mailboxSize<span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">action</span> <span class="op">=</span> action<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Future</span><span class="op">&lt;?&gt;</span> <span class="fu">sendAndAsyncWait</span><span class="op">(</span>T event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>running<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">(</span><span class="st">"the actor is down"</span><span class="op">);</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">FutureTask</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> future <span class="op">=</span> <span class="kw">new</span> <span class="bu">FutureTask</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        EventWrapper<span class="op">&lt;</span>T<span class="op">&gt;</span> wrapper <span class="op">=</span> <span class="kw">new</span> EventWrapper<span class="op">&lt;</span>T<span class="op">&gt;(</span>event<span class="op">,</span> future<span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        mailbox<span class="op">.</span><span class="fu">put</span><span class="op">(</span>wrapper<span class="op">);</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> future<span class="op">;</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>running<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                EventWrapper<span class="op">&lt;</span>T<span class="op">&gt;</span> wrapper <span class="op">=</span> mailbox<span class="op">.</span><span class="fu">take</span><span class="op">();</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                    action<span class="op">.</span><span class="fu">sinkEvent</span><span class="op">(</span>wrapper<span class="op">.</span><span class="fu">getEvent</span><span class="op">());</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                    action<span class="op">.</span><span class="fu">run</span><span class="op">();</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                    wrapper<span class="op">.</span><span class="fu">getFuture</span><span class="op">().</span><span class="fu">run</span><span class="op">();</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>                    logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">"exception in actor execution which will stop the actor:</span><span class="sc">\n</span><span class="st">{}"</span><span class="op">,</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                            ExceptionUtils<span class="op">.</span><span class="fu">getFullStackTrace</span><span class="op">(</span>e<span class="op">));</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>                logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">"ImprovedThreadBasedActor running thread is interrupted:{}"</span><span class="op">,</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>                        ExceptionUtils<span class="op">.</span><span class="fu">getFullStackTrace</span><span class="op">(</span>e<span class="op">));</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">"ImprovedThreadBasedActor is down."</span><span class="op">);</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">terminate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        running <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        ImprovedThreadBasedActor<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> actor <span class="op">=</span> <span class="kw">new</span> ImprovedThreadBasedActor<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;(</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">ActorClosureStub</span><span class="op">(),</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f1 <span class="op">=</span> actor<span class="op">.</span><span class="fu">sendAndAsyncWait</span><span class="op">(</span><span class="st">"a"</span><span class="op">);</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f2 <span class="op">=</span> actor<span class="op">.</span><span class="fu">sendAndAsyncWait</span><span class="op">(</span><span class="st">"b"</span><span class="op">);</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Future</span><span class="op">&lt;?&gt;</span> f3 <span class="op">=</span> actor<span class="op">.</span><span class="fu">sendAndAsyncWait</span><span class="op">(</span><span class="st">"c"</span><span class="op">);</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        f3<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"f2 is done? "</span> <span class="op">+</span> f2<span class="op">.</span><span class="fu">isDone</span><span class="op">());</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"f1 is done? "</span> <span class="op">+</span> f2<span class="op">.</span><span class="fu">isDone</span><span class="op">());</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"stop the actor."</span><span class="op">);</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">terminate</span><span class="op">();</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>No explanation on this, you can explore it yourself. There are several tricky things in the code, I hope you can figure out the reason. GL and HF.</p> 
     <h2 id="another-version">Another Version</h2> 
     <div class="sourceCode" id="cb8">
      <pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> This is a heavy weight thread based actor implementation<span class="co">.</span><span class="kw">&lt;br&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author fujohnwang</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>param <span class="kw">&lt;T&gt;</span><span class="co">,</span> the event type to be processed</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>param <span class="kw">&lt;R&gt;</span><span class="co">,</span> result type after processing the event<span class="co">.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ThreadActor<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Thread</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">transient</span> <span class="dt">final</span> <span class="bu">Logger</span>            logger  <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">getClass</span><span class="op">());</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">volatile</span> <span class="dt">boolean</span>                  running <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">BlockingQueue</span><span class="op">&lt;</span>EventWrapper<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;&gt;</span> mailbox<span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Reaction<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;</span>                    action<span class="op">;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ThreadActor</span><span class="op">(</span>Reaction<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;</span> action<span class="op">,</span> <span class="dt">int</span> mailboxSize<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">action</span> <span class="op">=</span> action<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">mailbox</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayBlockingQueue</span><span class="op">&lt;</span>EventWrapper<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;&gt;((</span>mailboxSize <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> <span class="dv">100</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">:</span> mailboxSize<span class="op">);</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Future</span><span class="op">&lt;</span>R<span class="op">&gt;</span> <span class="fu">sendAndAsycAwait</span><span class="op">(</span>T event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>running<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">(</span><span class="st">"the actor is down"</span><span class="op">);</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        FutureProxy<span class="op">&lt;</span>R<span class="op">&gt;</span> f <span class="op">=</span> <span class="kw">new</span> FutureProxy<span class="op">&lt;</span>R<span class="op">&gt;(</span><span class="kw">new</span> <span class="bu">FutureTask</span><span class="op">&lt;</span>R<span class="op">&gt;(</span><span class="kw">new</span> <span class="bu">Callable</span><span class="op">&lt;</span>R<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> R <span class="fu">call</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}));</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        mailbox<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="kw">new</span> EventWrapper<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;(</span>event<span class="op">,</span> f<span class="op">));</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f<span class="op">;</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>running<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>                EventWrapper<span class="op">&lt;</span>T<span class="op">,</span> R<span class="op">&gt;</span> e <span class="op">=</span> mailbox<span class="op">.</span><span class="fu">take</span><span class="op">();</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>                action<span class="op">.</span><span class="fu">sink</span><span class="op">(</span>e<span class="op">.</span><span class="fu">getEvent</span><span class="op">());</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                    R r <span class="op">=</span> action<span class="op">.</span><span class="fu">call</span><span class="op">();</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">getFuture</span><span class="op">().</span><span class="fu">setResult</span><span class="op">(</span>r<span class="op">);</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e1<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">getFuture</span><span class="op">().</span><span class="fu">setCause</span><span class="op">(</span>e1<span class="op">);</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">getFuture</span><span class="op">().</span><span class="fu">getDelegate</span><span class="op">().</span><span class="fu">run</span><span class="op">();</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">"actor shutdown"</span><span class="op">);</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">terminate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        running <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span> args<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        ThreadActor<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Boolean</span><span class="op">&gt;</span> actor <span class="op">=</span> <span class="kw">new</span> ThreadActor<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Boolean</span><span class="op">&gt;(</span><span class="kw">new</span> <span class="fu">ReactionStub</span><span class="op">(),</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                <span class="dv">10</span><span class="op">);</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        actor<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>actor<span class="op">.</span><span class="fu">sendAndAsycAwait</span><span class="op">(</span><span class="bu">String</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>i<span class="op">)).</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// </span><span class="al">TODO</span><span class="co"> Auto-generated catch block</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">ExecutionException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// </span><span class="al">TODO</span><span class="co"> Auto-generated catch block</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// </span><span class="al">TODO</span><span class="co"> Auto-generated catch block</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>            actor<span class="op">.</span><span class="fu">terminate</span><span class="op">();</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ReactionStub <span class="kw">implements</span> Reaction<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Boolean</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">long</span>   counter<span class="op">;</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> event<span class="op">;</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Boolean</span> <span class="fu">call</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>counter <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"message received:"</span> <span class="op">+</span> event<span class="op">);</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">(</span><span class="st">"sample exception"</span><span class="op">);</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>            counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">sink</span><span class="op">(</span><span class="bu">String</span> event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">event</span> <span class="op">=</span> event<span class="op">;</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre>
     </div> 
     <p>优劣不解释。</p> 
     <h1 id="conclusion">Conclusion</h1> 
     <p>The above words just a play-around, don’t treat it too serious. It’s not rocket science, If you are looking for such thing, get away. These words are not for you.</p> 
     <p><strong>Caution: The last method still has gotchas, Improvement is still in progress</strong></p> <!-- tail --> 
     <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3687639021943715" data-ad-slot="7874087130" data-ad-format="auto" data-full-width-responsive="true"></ins> 
     <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script> 
     <hr> 
     <div> <a href="/posts.html"> <b> &gt;&gt;&gt;&gt;&gt;&gt; 更多阅读 &lt;&lt;&lt;&lt;&lt;&lt; </b></a> 
     </div> 
     <div id="random_posts"> 
      <div class="alert alert-light" role="alert"> <a href="/posts/2017-05-06-emotion-is-more-powerful-than-rationality.html">为什么越是情绪化的事件或者越是偏激的观点，越能做成营销热点？！ </a> 
      </div> 
      <div class="alert alert-light" role="alert"> <a href="/posts/2012-09-17-vertical_stack_in_one.html">检车大厅所见所闻对软件架构设计的联想 </a> 
      </div> 
      <div class="alert alert-light" role="alert"> <a href="/posts/2013-04-23-transfer-file-with-nc-and-tar.html">使用nc或者结合tar进行文件传输 </a> 
      </div> 
     </div> 
     <hr> 
     <div id="comments"></div> 
     <hr> <!-- Section CTA --> 
     <section> <!-- Container --> 
      <div class="mx-auto w-full max-w-7xl px-5 py-16 md:px-10"> <!-- Component--> 
       <div class="grid items-center gap-8 sm:gap-20 lg:grid-cols-2"> 
        <div> 
         <h2 class="mb-4 max-w-2xl text-3xl font-bold md:text-5xl"><a href="https://afoo.me/kb.html">欢迎加入「福强私学」</a></h2> 
         <p class="mb-3 max-w-lg text-sm text-[#636262] sm:text-base">跨越2190个日夜，始终坚持“实践 + 原创”打造的715125字专属知识库，囊括了（但不限于）从职场、技术、管理与商业等多个板块的内容。</p> 
         <ul class="mb-3 max-w-lg text-sm text-[#636262] sm:text-base"> 
          <li>一个ChatGPT触达不到的地方</li> 
          <li>一个带你超越AI/人工智能的地方</li> 
          <li>一个与你一起成长的地方</li> 
         </ul> 
         <p class="mb-4 max-w-lg text-sm text-[#636262] sm:text-base"> <a href="https://afoo.me/kb.html" class="border-b">https://afoo.me/kb.html</a> </p> 
        </div> 
        <div> <a href="https://afoo.me/kb.html"> <img src="https://afoo.me/qrcodes/kb.afoo.me.png" alt="" class="mx-auto inline-block h-full w-full max-w-2xl"> </a> 
        </div> 
       </div> 
      </div> 
     </section> 
     <hr> 
     <p> <span style="font-size: xx-large;"> 开天窗，拉认知，订阅「福报」，即刻拥有自己的全模态人工智能。 </span> </p> <a href="https://wfq.gumroad.com/l/fb"> <img src="/images/fb_subscribe_v2.jpg" alt="订阅「福报」"> </a> 
     <hr> 
     <div hx-get="https://toolfooter.afoo.me/" hx-trigger="revealed" htmx-indicator="#tfloader"> 
      <div id="tfloader" class="x-indicator"> 
       <svg width="57" height="57" viewbox="0 0 57 57" xmlns="http://www.w3.org/2000/svg" stroke="#3F83F8"> <g fill="none" fill-rule="evenodd"> 
         <g transform="translate(1 1)" stroke-width="2"> 
          <circle cx="5" cy="50" r="5"> 
           <animate attributename="cy" begin="0s" dur="2.2s" values="50;5;50;50" calcmode="linear" repeatcount="indefinite" /> 
           <animate attributename="cx" begin="0s" dur="2.2s" values="5;27;49;5" calcmode="linear" repeatcount="indefinite" /> 
          </circle> 
          <circle cx="27" cy="5" r="5"> 
           <animate attributename="cy" begin="0s" dur="2.2s" from="5" to="5" values="5;50;50;5" calcmode="linear" repeatcount="indefinite" /> 
           <animate attributename="cx" begin="0s" dur="2.2s" from="27" to="27" values="27;49;5;27" calcmode="linear" repeatcount="indefinite" /> 
          </circle> 
          <circle cx="49" cy="50" r="5"> 
           <animate attributename="cy" begin="0s" dur="2.2s" values="50;50;5;50" calcmode="linear" repeatcount="indefinite" /> 
           <animate attributename="cx" from="49" to="49" begin="0s" dur="2.2s" values="49;5;27;49" calcmode="linear" repeatcount="indefinite" /> 
          </circle> 
         </g> 
        </g> 
       </svg> 
      </div> 
     </div> 
    </div> 
   </section> 
  </main> 
  <footer class="border-t border-gray-200 dark:border-slate-800"> 
   <div class="max-w-6xl mx-auto px-4 sm:px-6"> 
    <div class="md:flex md:items-center md:justify-between py-6 md:py-8"> 
     <ul class="flex mb-4 md:order-1 -ml-2 md:ml-4 md:mb-0"> 
      <li> <a class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="Twitter" href="https://twitter.com/afoo_me"> 
        <svg viewbox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:brand-twitter"> <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84 0 0 0 .497-3.753C20.18 7.773 21.692 5.25 22 4.009z"> 
         </path> 
        </svg> </a> </li> 
      <li> <a class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="Facebook" href="https://www.facebook.com/fujohnwang/"> 
        <svg viewbox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:brand-facebook"> <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 0 1 1-1h3V3h-3a5 5 0 0 0-5 5v2H7"></path> 
        </svg> </a> </li> 
      <li> <a class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center" aria-label="Github" href="https://github.com/fujohnwang"> 
        <svg viewbox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:brand-github"> <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6 0 0 0-1.3-3.2 4.2 4.2 0 0 0-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3 0 0 0-6.2 0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2 0 0 0-.1 3.2A4.6 4.6 0 0 0 4 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"> 
         </path> 
        </svg> </a> </li> 
     </ul> 
     <div class="text-sm text-gray-700 mr-4 dark:text-slate-400"> <span class="w-5 h-5 md:w-6 md:h-6 md:-mt-0.5 bg-cover mr-1.5 float-left rounded-sm"> <img src="https://afoo.me/favicon.svg" class="rounded-md" alt> </span> Copyright © 王福强个人版权所有 - Since 2004 (Everything is homebrewed with <a href="https://pandoc.org/">Pandoc</a> and Markdown, little <a href="https://www.scala-lang.org/">Scala</a> also included.) 
     </div> 
    </div> 
   </div> 
  </footer> 
  <script>
        // Set "light" theme as default
        if (!localStorage.theme) {
            localStorage.theme = "light";
        }

        if (
            localStorage.theme === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function attachEvent(selector, event, fn) {
            const matches = document.querySelectorAll(selector);
            if (matches && matches.length) {
                matches.forEach((elem) => {
                    elem.addEventListener(event, () => fn(elem), false);
                });
            }
        }

        window.onload = function () {
            attachEvent('[data-toggle-menu]', 'click', function (elem) {
                elem.classList.toggle('expanded');
                document.body.classList.toggle('overflow-hidden');
                document.getElementById('header')?.classList.toggle('h-screen');
                document.querySelector('#header nav')?.classList.toggle('hidden');
            });
            attachEvent('[data-toggle-color-scheme]', 'click', function () {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });
        };
        window.onpageshow = function () {
            const elem = document.querySelector('[data-toggle-menu]');
            if (elem) {
                elem.classList.remove('expanded');
            }
            document.body.classList.remove('overflow-hidden');
            document.getElementById('header')?.classList.remove('h-screen');
            document.querySelector('#header nav')?.classList.add('hidden');
        };
    </script> 
  <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '518a605d711883414ac0',
          clientSecret: '69fb8ccc0616c5bcbc64d24ece0d06d279da91ff',
          repo: 'afoo.me.comments',
          owner: 'fujohnwang',
          admin: ['fujohnwang'],
          id: location.pathname.substring(0, 49),      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comments')
    </script> 
  <script src="https://formspree.io/js/formbutton-v1.min.js" defer></script> 
  <script>
  /* paste this line in verbatim */
  window.formbutton=window.formbutton||function(){(formbutton.q=formbutton.q||[]).push(arguments)};
  /* customize formbutton below*/     
  formbutton("create", {
    action: "https://formspree.io/f/xknlpkkd",
    title: "有什么可以帮到您？💕💕💕 How can I help you?",
    buttonImg: "<img src='https://afoo.me/hero3/70.webp' alt/>",
    fields: [
      { 
        type: "email", 
        label: "您的电子邮箱（方便与您联系）:", 
        name: "email",
        required: true,
        placeholder: "your@email.com"
      },
      {
        type: "textarea",
        label: "您想提交的反馈和询问信息:",
        name: "message",
        placeholder: "What's on your mind?",
      },
      { type: "submit" }      
    ],
    styles: {
      title: {
        backgroundColor: "blue"
      },
      button: {
        backgroundColor: "blue"
      }
    }
  });
</script> 
  <script>
	// tooltips
	tippy('#aiedu', {
        content: "As to AI nowadays, LLM and Stable Diffusion are hot even hottest among them, If your want to both know-why and know-how with them, instead of only know-how which can't repeat itself, you should get you to https://ai.afoo.me right now ❗"
    });  
</script>  
 </body>
</html>