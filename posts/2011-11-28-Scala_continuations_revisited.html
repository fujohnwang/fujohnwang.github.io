<!doctype html>
<html lang="zh"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="keywords" content="Scala Continuations Revisited - 架构教练,架构师个人成长教练,个人成长,组织成长,个人与组织成长顾问, architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学"> 
  <meta name="description" content="Scala Continuations Revisited - 扶墙老师说，王福强的个人博客， 一个架构士的思考与沉淀"> 
  <meta name="author" content="王福强"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
  <title>Scala Continuations Revisited -王福强的个人博客：一个架构士的思考与沉淀</title> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <style type="text/css">code{white-space: pre;}</style> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> 
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> 
  <script type="text/javascript" src="/js/watermark.js"></script> <!-- Bootstrap core CSS --> 
  <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!-- Custom fonts for this template --> 
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> <!-- Custom styles for this template --> 
  <link href="/css/freelancer.css" rel="stylesheet"> 
  <style type="text/css">
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      text-align: left;
      position: relative;
      -webkit-font-smoothing: antialiased;
    }
    

    h1{
      margin-top: 3rem;
    }
  </style> 
 </head> 
 <body id="page-top"> <!-- Navigation --> 
  <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav"> 
   <div class="container"> <a class="navbar-brand js-scroll-trigger" href="/"> <img src="/images/profile.jpeg" alt="" style="display: inline; border-radius: 50%; height: 50px;">王福强的个人博客 </a> <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"> Menu <i class="fas fa-bars"></i> </button> 
    <div class="collapse navbar-collapse" id="navbarResponsive"> 
     <ul class="navbar-nav ml-auto"> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/posts.html">博客文章</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/books.html">创作出版</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="https://edu.afoo.me">福强AI学堂</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/crosslinks.html">更多链接</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/whoami.html">关于我</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/feeds.xml">RSS订阅</a> </li> 
     </ul> 
    </div> 
   </div> 
  </nav> 
  <section> 
   <div class="container"> <!--        <div class="row">--> <!--          <div class="col-lg-8 mx-auto">--> 
    <p class="lead"> </p>
    <h1 class="title">Scala Continuations Revisited</h1> <small> <h3 class="author">fujohnwang</h3> 
     <div style="text-align: left;">
      2011-11-28 Scala Continuations Revisited
     </div> </small> 
    <p></p> 
    <hr> 
    <p>The continuation is all about <strong>suspend</strong> and <strong>resume</strong> semantic, the idea is simple, powerful, but hard to get, especially when you try to rewind your mind from threading world.</p> 
    <p>After Scala2.8, a kind of continuation is introduced, which is called <strong>delimited continuation</strong>, aka. <em>partial continuation</em> or <em>composable continuation</em>, I had tried to understand scala’s continuation support well before, but didn’t get too much, So today, I try to do same thing again, here are some of the information that I regroup from former collections or new sources, I don’t hope to understand it this time either, but at least I leave some footprint. :-)</p> 
    <blockquote> 
     <p>To understand Continuation and CPS concepts well, Jim Mcbeath’s blog post on <a href="http://jim-mcbeath.blogspot.com/2010/08/delimited-continuations.html">Delimited Continuation</a> is highly recommended to read!!!</p> 
    </blockquote> 
    <hr> 
    <h1 id="classification-of-continuation">Classification Of Continuation</h1> 
    <ol type="1"> 
     <li>Full Continuation / First-Class Continuation</li> 
     <li>Delimited Continuations / Partial Continuation / Composable Continuation</li> 
    </ol> 
    <hr> 
    <h1 id="how-to-enable-scalas-continuation-support">How to enable scala’s continuation support?</h1> 
    <ol type="1"> 
     <li>enable compiler plugin 
      <ul> 
       <li>with compiler, <code>scalac -P:continuations:enable</code></li> 
       <li>with REPL, <code>scala -P:continuations:enable</code></li> 
      </ul></li> 
     <li>import continuation library 
      <ul> 
       <li><code>import scala.util.continuations._</code></li> 
      </ul></li> 
    </ol> 
    <hr> 
    <h1 id="scala-continuation初瞥">Scala Continuation初瞥</h1> 
    <pre>reset{
    shift{continuationRef=&gt;
        // 1. do something
        // 2. execution the continuation captured.
        continuationRef()
    }
    continuationBody()
}
</pre> 
    <p><strong>reset</strong> will setup/demarcate the boundary of the delimited continuation while <strong>shift</strong> will capture the delimited continuation. In above code snippet, <em>continuationRef</em> argument of shift is the captured DC which in fact is the <em>continuationBody()</em> part of the code.</p> 注意： continuation指的是reset界定中shift后面剩余的部分， 这里很容易让expression和statement搞糊涂, 比如： 
    <pre class="prettyprint">reset {
    println("A")
    shift { k1: (Unit=&gt;Unit) =&gt;
        println("B")
        k1()
        println("C")
    }
    println("D")
    shift { k2: (Unit=&gt;Unit) =&gt;
        println("E")
        k2()
        println("F")
    }
    println("G")
}
</pre> 与 
    <pre class="prettyprint">reset {
  1+ 
  shift { k: (Int=&gt;Int) =&gt;
    k(7)
  } + 1
}
</pre> 
    <p>可能因为是代码写法的缘故，一开始很容易搞不清楚为什么第一个例子中<code>println("A")</code>不包含在continuation中并且自己单独先执行，而后面一个代码事例中却将开始的1＋算在continuation中，其实差别就是expression跟statement，原则上来讲， 是自己没有真正理解continuation的概念和scala的程序结构，呵呵</p> 
    <p>There are thus three types associated with shift:</p> 
    <ul> 
     <li>The type of the argument to pass to the continuation, which is the same as the syntactic return type of the shift in the source code.</li> 
     <li>The type of the return from the continuation, which is the same as the return type of all of the code that follows the shift block in the source code (i.e.&nbsp;the type of the last value in the block of code between the shift block and the end of the function or reset block containing the shift block). This is called the untransformed return type.</li> 
     <li>The type of the last value in the shift block, which becomes the type of the return value of the enclosing function or return block. This is called the transformed return type.</li> 
    </ul> 
    <p>In the signature for shift, the above three types appear as A, B and C, respectively: <code>shift [A, B, C] (fun: ((A) ⇒ B) ⇒ C): A @scala.util.continuations.cpsParam[B,C]</code></p> 
    <p>Here’s where those types appear: <code>C = reset { ...; A = shift { k:(A=&gt;B) =&gt; ...; C } ...; B }</code></p> 
    <hr> 
    <h1 id="yield-or-return">yield or return</h1> 
    <p>shift捕获当前reset界定的continuation，在shift中可以直接调用并执行捕获的continuation，也可以将该continuation交给其他组件而暂时不执行，比如放入某个queue中，由某个组件集中调度其执行。</p> 
    <ul> 
     <li>yield = return the captured continuation from shift directly without invoking it, just like a function or closure is returned as result value.</li> 
     <li>return = invoke the captured continuation in the shift directly</li> 
    </ul> 
    <p>除了在shift中捕获continuation并决定如何使用，我们还可以在shift中做其它事情，而不单单是为了捕获的continuation而“或者”，呵呵</p> 
    <hr> 
    <h1 id="潜在的可以简化的编程场景">潜在的可以简化的编程场景</h1> 
    <ol type="1"> 
     <li>doing asynchronous I/O using Java NIO</li> 
     <li>using executors and thread pools</li> 
     <li>handling cross-request control flow in web applications</li> 
    </ol> 
    <hr> 
    <h1 id="multitasking-with-scala-continuations">multitasking with scala continuations</h1> 
    <p>The key different with threading model is that multitasking with continuations is coorperitive while multitasking with threads is preemptive. So the key point to make multitasking with continuation works is we need to offer a custom scheduler for the continuations execution and coordination.</p> 
    <pre>reset {
    shift{
        cont:(()=&gt;Unit) =&gt; {
            connect() // synchronous
            startDump() // synchronous
            scheduler.register(cont) // yield without execution immediately since the io might be not ready.
        }
    }
    readBinlogEventsAndProcess()
}

scheduler.selectAndNotify
</pre> 
    <hr> 
    <h1 id="值得参考的项目">值得参考的项目</h1> 
    <ol type="1"> 
     <li>Swarm 
      <ul> 
       <li><a href="http://vimeo.com/6614042" class="uri">http://vimeo.com/6614042</a></li> 
       <li><a href="http://www.earldouglas.com/actor-based-continuations-with-akka-and-swarm/" class="uri">http://www.earldouglas.com/actor-based-continuations-with-akka-and-swarm/</a></li> 
      </ul></li> 
     <li>Akka’s DataFlow and NIO actor implementations</li> 
     <li>Jim McBeath的blog posts和github项目(Scoroutine &amp; NIOServer)</li> 
     <li>Loft - <a href="https://github.com/rschildmeijer/loft" class="uri">https://github.com/rschildmeijer/loft</a></li> 
    </ol> 
    <hr> 
    <h1 id="一些模式与规则">一些模式与规则</h1> 
    <ol type="1"> 
     <li>“All code inside the reset, minus the shift expressions, is turned into continuations”</li> 
     <li>reset的返回值类型跟shift的返回值类型相同？！ - “the value of the evaluated reset block is the value of the last expression in the shift block that gets executed within that reset block”</li> 
     <li>“<strong>The gist of CPS is that we don’t use return</strong>. Rather than calling a subroutine and having it return to us, as is the case in the normal Direct Style, we pass a continuation to the subroutine for it to execute when it is done.”</li> 
     <li>“In every method where we call a subroutine using CPS, that call is always the very last thing in the method.”</li> 
     <li>“Any method that includes shift must be marked as CPS, and any method that calls a CPS method must be marked as CPS, until you reach the enclosing reset call.”</li> 
     <li></li> 
    </ol> 
    <hr> 
    <h1 id="limitations">Limitations</h1> 
    <ol type="1"> 
     <li>Using return statements in a CPS function is unlikely to do what you expect, and may cause type mismatch compiler errors, so you should not use them.</li> 
     <li>When using an if statement, you may get an error like this: <code>Foo.scala:21: error: then and else parts must both be cps code or neither of them</code></li> 
     <li>The compiler plugin does not handle try blocks, so you can’t catch exceptions within CPS code. Those exceptions will be propagated out to the enclosing reset block and can be caught there - unless the continuation is suspended and executed later, in which case any exceptions would be propagated to the reset block of the code doing that later execution.</li> 
     <li>You need to be careful when using looping constructs. As <a href="http://scala-programming-language.1934581.n4.nabble.com/scala-Tail-Recursive-Calls-possible-inside-CPS-td2221188.html#a2226758">Tiark says</a>, <code>Capturing delimited continuations inside a while loop turns the loop basically into a general recursive function.</code> You can follow the above link for details, but basically each invocation of shift within a looping construct allocates another stack frame, so after “looping” many times you will likely get a StackOverflowError.</li> 
     <li>Some looping constructs can not be used with a shift inside them. To quote Tiark again: <code>In a reset block you can do anything, but shifts are not allowed everywhere. The limitation is that everything on the call path between a shift and its enclosing reset must be "shift-aware". That rules out the regular foreach, map and filter methods because they know nothing about continuations, so they can't call closures containing shift.</code></li> 
    </ol> 
    <hr> 
    <h1 id="read-more">Read More…</h1> 
    <ol type="1"> 
     <li>My Question On Quora - <a href="http://www.quora.com/How-does-Scala-continuation-work-and-has-there-been-some-successful-system-built-on-it" class="uri">http://www.quora.com/How-does-Scala-continuation-work-and-has-there-been-some-successful-system-built-on-it</a></li> 
     <li><strong>highly recommended</strong> - <a href="http://jim-mcbeath.blogspot.com/2010/08/delimited-continuations.html" class="uri">http://jim-mcbeath.blogspot.com/2010/08/delimited-continuations.html</a></li> 
     <li><a href="http://ebruchez.blogspot.com/2011/09/continuations-in-scala.html" class="uri">http://ebruchez.blogspot.com/2011/09/continuations-in-scala.html</a></li> 
     <li>Scala continuations and NIO meet JVM coroutines - <a href="http://skillsmatter.com/podcast/scala/scala-continuations" class="uri">http://skillsmatter.com/podcast/scala/scala-continuations</a></li> 
     <li>Swarm Discussion On Lambda the Ultimate - <a href="http://lambda-the-ultimate.org/node/3626" class="uri">http://lambda-the-ultimate.org/node/3626</a></li> 
     <li><a href="http://www.slideshare.net/openbala/continuations" class="uri">http://www.slideshare.net/openbala/continuations</a></li> 
     <li><a href="http://biosimilarity.blogspot.com/2011/01/rabbitmq-monadically.html" class="uri">http://biosimilarity.blogspot.com/2011/01/rabbitmq-monadically.html</a></li> 
     <li><a href="http://suereth.blogspot.com/2010/03/how-you-should-think-about-delimited.html" class="uri">http://suereth.blogspot.com/2010/03/how-you-should-think-about-delimited.html</a></li> 
     <li><a href="http://www.earldouglas.com/asynchronous-network-io-with-scala-continuations/" class="uri">http://www.earldouglas.com/asynchronous-network-io-with-scala-continuations/</a></li> 
     <li><a href="http://www.infoq.com/articles/deft-loft" class="uri">http://www.infoq.com/articles/deft-loft</a></li> 
     <li><a href="http://lampsvn.epfl.ch/trac/scala/browser/compiler-plugins/continuations/trunk/doc/examples/continuations/Test17Webserver.scala" class="uri">http://lampsvn.epfl.ch/trac/scala/browser/compiler-plugins/continuations/trunk/doc/examples/continuations/Test17Webserver.scala</a></li> 
     <li><a href="http://lampsvn.epfl.ch/trac/scala/browser/compiler-plugins/continuations/trunk/doc/examples/continuations" class="uri">http://lampsvn.epfl.ch/trac/scala/browser/compiler-plugins/continuations/trunk/doc/examples/continuations</a></li> 
    </ol> <!--          </div>--> <!--        </div>--> 
    <hr> 
    <div> 
     <p> 「为AI疯狂」星球上，扶墙老师正在和朋友们讨论有趣的AI话题，你要不要⼀起来呀？^-^<br> 这里 </p>
     <ol> 
      <li>不但有及时新鲜的AI资讯和深度探讨</li> 
      <li>还分享AI工具、产品方法和商业机会</li> 
      <li>更有原价1000多的付费内容(近500分钟)等着你，<a href="https://t.zsxq.com/0dI3ZA0sL">加入星球(https://t.zsxq.com/0dI3ZA0sL)</a> 即可免费领取! </li> 
     </ol> 
     <p></p> <a href="https://t.zsxq.com/0dI3ZA0sL"> <img src="/posts/images/2023-05-06-12-09-53.jpg" alt="知识星球二维码"> </a> 
    </div> 
    <hr> 
    <div> <a href="/posts.html"> <b> &gt;&gt;&gt;&gt;&gt;&gt; 更多阅读 &lt;&lt;&lt;&lt;&lt;&lt; </b></a> 
    </div> 
    <div id="random_posts"> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2009-10-29-create-custom-maven-archetype.html">自定义Maven archetype的创建 </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2015-02-17-my-actor-practice-advices.html">Practice Advices On Design and Impl. with Actor Model </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2017-10-13-will-and-hold-on.html">扶墙老师谈管理之再说“心硬” </a> 
     </div> 
    </div> 
    <hr> <a href="https://wfq.gumroad.com/l/fb"> <img src="/images/fb_subscribe.jpg" alt="订阅「福报Premium订阅」"> </a> 
    <div id="comments"></div> 
    <hr> 
    <div class="text-center"> <a href="https://twitter.com/fujohnwang"> <img src="/images/Twitter-logo.png" class="img-responsive" loading="lazy" style="width: fit-content;"> </a> 
    </div> 
   </div> 
  </section> 
  <div style="color:white; visibility: collapse; height: 0;">
   ©<a href="/whoami.html">王福强</a>个人版权所有, All Rights Reserved.
  </div> 
  <div class="copyright py-4 text-center text-white"> 
   <div class="container"> <small>Copyright © <a href="/whoami.html">王福强</a>个人版权所有 - Since 2004</small> 
    <br><small>Everything is homebrewed with <a href="https://pandoc.org/">pandoc</a> and <a href="https://daringfireball.net/projects/markdown/syntax">Markdown</a>, little <a href="https://www.scala-lang.org/">Scala</a> also included.</small> 
   </div> 
  </div> 
  <script type="text/javascript">
var gitalk = new Gitalk({
  clientID: '518a605d711883414ac0',
  clientSecret: '69fb8ccc0616c5bcbc64d24ece0d06d279da91ff',
  repo: 'afoo.me.comments',
  owner: 'fujohnwang',
  admin: ['fujohnwang'],
  id: location.pathname.substring(0, 49),      // Ensure uniqueness and length less than 50
  distractionFreeMode: false  // Facebook-like distraction free mode
})

gitalk.render('comments')
    </script> 
  <script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script> 
  <script>
  kofiWidgetOverlay.draw('fff000', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': 'red',
    'floating-chat.donateButton.text-color': 'white'
  });
</script> 
  <script>
  fetch('https://jsonld.afoo.me', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      url: window.location.href
    })
  }).then(response => response.text()).then(structuredDataText => {
    const script = document.createElement('script');
    script.setAttribute('type', 'application/ld+json');
    script.textContent = structuredDataText;
    document.head.appendChild(script);
  });
</script>  
  <script>watermark.init({ watermark_txt: "©王福强个人版权所有, All Rights Reserved." , watermark_width:200})</script> 
 </body>
</html>