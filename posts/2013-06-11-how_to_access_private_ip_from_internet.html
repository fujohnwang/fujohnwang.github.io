<!doctype html>
<html lang="zh"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="keywords" content="教你如何使用卡片电脑对外提供网络服务 - 架构教练,架构师个人成长教练,个人成长,组织成长,个人与组织成长顾问, architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学"> 
  <meta name="description" content="教你如何使用卡片电脑对外提供网络服务 - 扶墙老师说，王福强的个人博客， 一个架构士的思考与沉淀"> 
  <meta name="author" content="王福强"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
  <title>教你如何使用卡片电脑对外提供网络服务 -王福强的个人博客：一个架构士的思考与沉淀</title> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <style type="text/css">code{white-space: pre;}</style> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> 
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> 
  <script type="text/javascript" src="/js/watermark.js"></script> <!-- Bootstrap core CSS --> 
  <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!-- Custom fonts for this template --> 
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> <!-- Custom styles for this template --> 
  <link href="/css/freelancer.css" rel="stylesheet"> 
  <style type="text/css">
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      text-align: left;
      position: relative;
      -webkit-font-smoothing: antialiased;
    }
    

    h1{
      margin-top: 3rem;
    }
  </style> 
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "教你如何使用卡片电脑对外提供网络服务",
      "image": [
        "https://afoo.me/images/fb_subscribe.jpg"
       ],
      "datePublished": "0000-00-00",
      "author": [{
          "@type": "Person",
          "name": "王福强",
          "url": "https://afoo.me"
        }]
    }
  </script> 
 </head> 
 <body id="page-top"> <!-- Navigation --> 
  <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav"> 
   <div class="container"> <a class="navbar-brand js-scroll-trigger" href="/"> <img src="/images/profile.jpeg" alt="" style="display: inline; border-radius: 50%; height: 50px;">王福强的个人博客 </a> <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"> Menu <i class="fas fa-bars"></i> </button> 
    <div class="collapse navbar-collapse" id="navbarResponsive"> 
     <ul class="navbar-nav ml-auto"> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/posts.html">博客文章</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/books.html">创作出版</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="https://edu.afoo.me">福强AI学堂</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/crosslinks.html">更多链接</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/whoami.html">关于我</a> </li> 
      <li class="nav-item mx-0 mx-lg-1"> <a class="nav-link py-3 px-0 px-lg-3" href="/feeds.xml">RSS订阅</a> </li> 
     </ul> 
    </div> 
   </div> 
  </nav> 
  <section> 
   <div class="container"> <!--        <div class="row">--> <!--          <div class="col-lg-8 mx-auto">--> 
    <p class="lead"> </p>
    <h1 class="title">教你如何使用卡片电脑对外提供网络服务</h1> <small> <h3 class="author">王福强</h3> 
     <div style="text-align: left;"></div> </small> 
    <p></p> 
    <hr> 
    <p><strong>Tags</strong>: 私有IP(Private IP), DHCP, NAT, Router, 动态IP(Dynamic IP), DNS, Dynamic DNS</p> 
    <p>买个卡片电脑总得让它排上点儿用场，对吧？ 耗电低，当个服务器挂着对外提供点儿web服务啥的是个比较普通又能够快速想到的用途，挂个博客或者小站啥的，还是比较可行的嘛，所以，开工～</p> 
    <h1 id="私有ip的壁垒">私有IP的壁垒</h1> 
    <p>假设家里的网络结构是这样的：</p> 
    <pre>猫 -&gt; 路由器(router) -&gt; (pc, laptop, card computer, ipad, smartphone...)
</pre> 
    <p>那么，不出意外的话，我们的卡片电脑会被分配一个私有IP(遵循RFC1918)， 这个私有IP的边界被限定在路由器后面，从而外部网络实际上是无法访问到我们的卡片电脑的， 我们遇到第一个障碍 ：（</p> 
    <blockquote> 
     <p>外延</p> 本地家庭网络内各个设备的本地私有IP实际上是路由器根据DHCP自动分配的， 通常是动态的IP， 我们也可以手动配置静态IP。 
    </blockquote> 
    <h1 id="public-ip的巧取豪夺">Public IP的巧取豪夺</h1> 
    <p>既然我们的卡片电脑获得的私有IP无法被外部访问并对外进行服务，那么我们能不能给它搞一个Public IP那？ 实际上，ISP本来就分配了一个Public IP给我们，只是在我们的本地网络拓扑中，被路由器(router)使用了，如果我们不用路由器，直接让卡片电脑通过猫猫来联网的话，外部就可以通过ISP分配给我们的Public IP访问我们的卡片电脑了，所以，问题解决了。</p> 
    <h1 id="命名服务让生活更美好">命名服务让生活更美好</h1> 
    <p>你是愿意让外部的访问者（甚至包括你自己）每次记住IP地址的数字串来访问卡片电脑，还是更愿意只记住一个容易记住的名字？ 我想，大多数人会选择后者吧！</p> 
    <p>我们可以为我们的卡片电脑配置hostname，但是，hostname的机制太狭隘了，没法从更大范围上通过它来访问目标机器，所以，我们需要求助DNS， 这tmd才是global的那！</p> 
    <p>注册一个域名(Domain Name), 在域名服务商的name server上将域名和卡片电脑使用的Public IP的映射关系进行配置，搞定之后，等合适的时间间隔之后(域名记录的分发需要时间，你懂的，对吧？！)， 我们就可以直接让外部通过域名访问我们的卡片电脑啦～</p> 
    <h1 id="dynamic-ip之痒">Dynamic IP之痒</h1> 
    <p>Shit Happens～</p> 
    <p>某一时刻，或许是其他访问者告诉我们，通过域名无法访问我们的卡片电脑了，或者也可能是我们自己发现无法访问的， 到底是哪里出了问题那？</p> 
    <p>我们从DNS的name server开始查，发现name server没事儿； 那是我们自己的卡片电脑挂了？ 也没事儿啊！ 那么，是映射记录被人改了？ 我擦， 怎么卡片电脑的Public IP跟原来配置的不一样了那？！</p> 
    <p>原来， ISP分配给我们的Public IP是有租期(lease)的，过了租期，ISP可能让我们继续续租（即让我们继续持有原来的IP），也可能给我们换一个IP, 这种情况下，我们通过域名访问的就是原来的IP啦，而我们的卡片电脑现在持有的却是另一个IP，当然就访问不到咯！</p> 
    <p>那么咋整那？！使用动态DNS服务(Dynamic DNS, DDNS)呗！</p> 
    <p>偶的域名是godaddy注册的，但没稀的用他家的name server，改用了<a href="https://www.dnspod.cn/">DNSPod</a>， 所以，可以通过API来更改域名记录， 大体上，这个过程是这样的：卡片电脑上部署一个daemon程序， 该程序定期检查Public IP，如果发现跟原来持有的不同，则通过DNSPod的API接口更新对应域名的A记录，这样， 不管Public IP怎么变，我们都可以及时的更新域名记录，从而保证通过域名访问畅通无阻！</p> 
    <blockquote>
      当然啦， 域名记录的更新间隔，以及域名记录的分发时间，都会多少影响服务访问的可用性，这显然不是啥大问题，俺们又不是在搞啥商业高可用网站，是吧？ 
    </blockquote> 
    <h1 id="路由器我们不能失去你">路由器，我们不能失去你～</h1> 
    <p>卡片电脑直接通过猫猫联网倒是解决了自己的生存出路，可是，其他设备咋活啊？ 人家的pc啦， laptop啦， ipad啦，也都需要上网啊，总得给人家条活路不是？ 群众的呼声是不能忽视的，我们还得把路由器接回来！</p> 
    <p>将路由器接回来之后， 路由器就持有了ISP分配给我们的Public IP， 而为我们的所有本地设备分配了相应的Private IP，出路的问题解决了，我们需要继续解决卡片电脑的访客通道问题， 这个时候，就该让NAT (<a href="https://en.wikipedia.org/wiki/Network_address_translation">Network Address Translation</a>)出场了！</p> 
    <p>NAT简单来讲就是把内部的Private IP跟外部的Public IP做一层关系映射，映射关系的确定可以是通过端口，也可以通过IP或者其它多种方式， 一般的路由器现在都有NAT软件和相应的功能， 只要设置一下就可以了，具体如何设置可以参考自己的路由器说明书，这里不做赘述。</p> 
    <p>NAT配置好之后，就剩下一个问题了，即Public IP的获取。 我们用来获取Public IP的daemon程序是部署在卡片电脑上的，而卡片电脑现在分配到的是本地私有IP，<code>ifconfig</code>在这里是帮不了什么忙的， 不过有几种思路供参考：</p> 
    <ol type="1"> 
     <li>通过查找本地路由表信息，然后解析出相应的路由记录中的Public IP信息: <code>netstat -nr</code></li> 
     <li>访问相应的显示IP信息的web站点，然后提取，比如<a href="http://ip.chinaz.com/">Chinaz站长工具中的IP查询功能</a></li> 
     <li>我最中意的方法， <code>nc ns1.dnspod.net 6666</code>, DNSPod Rocks!</li> 
    </ol> 
    <p>使用第三种方式，就可以维持原有基础设置不变，而又能够提供DDNS记录的更新啦，哈，基本搞定！</p> 
    <h1 id="the-final-picture">The Final Picture</h1> 
    <p>在整个pipeline中，几个关键设备或者角色是需要我们着重关注的：</p> 
    <ol type="1"> 
     <li>路由器+NAT, 保证可以让外部访问者可以访问到内部的服务；</li> 
     <li>DNS和DDNS， 保证以统一的命名来访问同一服务， 不管服务器的IP如何变化</li> 
     <li>本地的daemon程序， 这个是无论动态IP如何变化，我们都能对外提供服务的基础关键组件，虽然简单，但不可或缺。</li> 
    </ol> 
    <h1 id="references">References</h1> 
    <p>其实参考了很多资料，也咨询了些人(比如李晓波同学)， 但过去了这么长时间，才想起这个东西该落实到文字记录一下，所以，之前参考了哪些资料不可考了，这里就不罗列了，不过，要是想简单了解一下NAT和路由器，可以参考这篇<a href="http://networking.nitecruzr.net/2005/05/what-is-nat-router.html">What Is A NAT Router?</a></p> 
    <h1 id="相关项目">相关项目</h1> 
    <ol type="1"> 
     <li><a href="http://xip.io/">xip.io</a></li> 
     <li><a href="https://ngrok.com/">ngrok</a></li> 
    </ol> <!--          </div>--> <!--        </div>--> 
    <hr> 
    <div> <a href="/posts.html"> <b> &gt;&gt;&gt;&gt;&gt;&gt; 更多阅读 &lt;&lt;&lt;&lt;&lt;&lt; </b></a> 
    </div> 
    <div id="random_posts"> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2023-04-18-comfyui.html">Stable Diffusion系列第三部「ComfyUI从入门到精通」炽热上线啦～ </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2009-03-09-slow-process-of-publishing-book.html">这出本书简直比生孩子都费劲… </a> 
     </div> 
     <div class="alert alert-light" role="alert"> <a href="/posts/2015-07-21-scala-developers-springboot-guide.html">Scala开发者的SpringBoot快速入门指南 </a> 
     </div> 
    </div> 
    <hr> 
    <div> 
     <p> 「为AI疯狂」星球上，扶墙老师正在和朋友们讨论有趣的AI话题，你要不要⼀起来呀？^-^<br> 这里 </p>
     <ol> 
      <li>不但有及时新鲜的AI资讯和深度探讨</li> 
      <li>还分享AI工具、产品方法和商业机会</li> 
      <li>更有体系化精品付费内容等着你，<a href="https://t.zsxq.com/0dI3ZA0sL">加入星球(https://t.zsxq.com/0dI3ZA0sL)</a> 即可免费领取。(加入之后<b>一定记得看置顶消息</b>呀！)</li> 
     </ol> 
     <p></p> <a href="https://t.zsxq.com/0dI3ZA0sL"> <img src="/posts/images/2023-05-06-12-09-53.jpg" alt="知识星球二维码"> </a> 
    </div> 
    <hr> 
    <p> <span style="font-size: xx-large;">存量的时代，省钱就是赚钱。</span> <br> <span style="font-size: xx-large;">在增量的时代，省钱其实是亏钱。</span> <br> 避坑儿是省钱的一种形式，更是真正聪明人的选择！ <br> 弯路虽然也是路，但还是能少走就少走，背后都是高昂的试错成本。 </p> <a href="https://wfq.gumroad.com/l/fb"> <img src="/images/fb_subscribe.jpg" alt="订阅「福报Premium订阅」"> </a> 
    <div id="comments"></div> 
    <hr> 
    <div class="text-center"> <a href="https://twitter.com/fujohnwang"> <img src="/images/Twitter-logo.png" class="img-responsive" loading="lazy" style="width: fit-content;"> </a> 
    </div> 
   </div> 
  </section> 
  <div style="color:white; visibility: collapse; height: 0;">
   ©<a href="/whoami.html">王福强</a>个人版权所有, All Rights Reserved.
  </div> 
  <div class="copyright py-4 text-center text-white"> 
   <div class="container"> <small>Copyright © <a href="/whoami.html">王福强</a>个人版权所有 - Since 2004</small> 
    <br><small>Everything is homebrewed with <a href="https://pandoc.org/">pandoc</a> and <a href="https://daringfireball.net/projects/markdown/syntax">Markdown</a>, little <a href="https://www.scala-lang.org/">Scala</a> also included.</small> 
   </div> 
  </div> 
  <script type="text/javascript">
var gitalk = new Gitalk({
  clientID: '518a605d711883414ac0',
  clientSecret: '69fb8ccc0616c5bcbc64d24ece0d06d279da91ff',
  repo: 'afoo.me.comments',
  owner: 'fujohnwang',
  admin: ['fujohnwang'],
  id: location.pathname.substring(0, 49),      // Ensure uniqueness and length less than 50
  distractionFreeMode: false  // Facebook-like distraction free mode
})

gitalk.render('comments')
    </script> 
  <script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script> 
  <script>
  kofiWidgetOverlay.draw('fff000', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': 'red',
    'floating-chat.donateButton.text-color': 'white'
  });
</script>  <!-- <script>watermark.init({ watermark_txt: "©王福强个人版权所有, All Rights Reserved." , watermark_width:200})</script> --> 
 </body>
</html>